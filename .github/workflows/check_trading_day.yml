name: "Check Trading Day"

on:
  workflow_call:
    inputs:
      check_mode:
        description: 'æª¢æŸ¥æ¨¡å¼: today=ä»Šå¤©æ˜¯å¦äº¤æ˜“æ—¥, yesterday=æ˜¨å¤©æ˜¯å¦äº¤æ˜“æ—¥'
        type: string
        default: 'today'
      force:
        description: 'å¼·åˆ¶è·³éŽæª¢æŸ¥'
        type: boolean
        default: false
    secrets:
      FINMIND_TOKEN:
        required: true
    outputs:
      is_trading_day:
        description: 'æ˜¯å¦ç‚ºäº¤æ˜“æ—¥ (true/false)'
        value: ${{ jobs.check.outputs.is_trading_day }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      is_trading_day: ${{ steps.check.outputs.is_trading_day }}
    steps:
      - name: Check trading day (FinMind API)
        id: check
        run: |
          # Force mode
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "âš ï¸ [Force Mode] è·³éŽäº¤æ˜“æ—¥æª¢æŸ¥"
            echo "is_trading_day=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # æ±ºå®šæª¢æŸ¥æ—¥æœŸ
          if [ "${{ inputs.check_mode }}" = "yesterday" ]; then
            CHECK_DATE=$(date -u -d "yesterday" +%Y-%m-%d)
            echo "ðŸ“… æª¢æŸ¥æ˜¨å¤© ($CHECK_DATE) æ˜¯å¦ç‚ºäº¤æ˜“æ—¥..."
          else
            CHECK_DATE=$(date -u +%Y-%m-%d)
            echo "ðŸ“… æª¢æŸ¥ä»Šå¤© ($CHECK_DATE) æ˜¯å¦ç‚ºäº¤æ˜“æ—¥..."
          fi

          # é€±æœ«å¿«é€ŸæŽ’é™¤ (1=Mon..7=Sun)
          DAY_OF_WEEK=$(date -u -d "$CHECK_DATE" +%u)
          if [ "$DAY_OF_WEEK" -ge 6 ]; then
            echo "ðŸ’¤ $CHECK_DATE æ˜¯é€±æœ«ï¼Œéžäº¤æ˜“æ—¥ã€‚"
            echo "is_trading_day=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # FinMind API æŸ¥è©¢
          RESP=$(curl -s --retry 3 --retry-delay 2 \
            "https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockTradingDate&start_date=$CHECK_DATE&end_date=$CHECK_DATE&token=${{ secrets.FINMIND_TOKEN }}")

          if echo "$RESP" | jq -e ".data[] | select(.date == \"$CHECK_DATE\")" > /dev/null 2>&1; then
            echo "âœ… $CHECK_DATE ç¢ºèªç‚ºäº¤æ˜“æ—¥ã€‚"
            echo "is_trading_day=true" >> "$GITHUB_OUTPUT"
          else
            echo "ðŸ’¤ $CHECK_DATE éžäº¤æ˜“æ—¥ï¼ˆåœ‹å®šå‡æ—¥æˆ–ç„¡è³‡æ–™ï¼‰ã€‚"
            echo "is_trading_day=false" >> "$GITHUB_OUTPUT"
          fi
